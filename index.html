<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI Rhythm Master - 161 BPM Demo</title>
    <style>
        :root { --neon-blue: #00f3ff; --neon-pink: #ff00ff; --bg-dark: #1a1a2e; }
        body { background-color: var(--bg-dark); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; overflow: hidden; }
        h1 { margin: 20px 0; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }
        #game-wrapper { position: relative; width: 400px; height: 600px; background: rgba(255, 255, 255, 0.05); border: 2px solid var(--neon-blue); border-radius: 15px; overflow: hidden; }
        #webcam-container { position: absolute; top: 10px; right: 10px; width: 100px; height: 100px; border: 2px solid var(--neon-pink); border-radius: 10px; z-index: 10; overflow: hidden; }
        #webcam-container canvas { width: 100%; height: 100%; }
        #game-canvas { width: 100%; height: 100%; }
        #ui-layer { position: absolute; top: 20px; left: 20px; z-index: 5; }
        .score-board { font-size: 20px; color: var(--neon-pink); font-weight: bold; }
        .feedback { font-size: 40px; font-weight: 800; color: white; margin-top: 150px; text-align: center; width: 400px; position: absolute; pointer-events: none; }
        #start-btn { padding: 15px 40px; font-size: 20px; background: transparent; color: var(--neon-blue); border: 2px solid var(--neon-blue); border-radius: 30px; cursor: pointer; margin-top: 20px; z-index: 100; }
        #start-btn:hover { background: var(--neon-blue); color: black; box-shadow: 0 0 20px var(--neon-blue); }
    </style>
</head>
<body>

    <h1>AI RHYTHM MASTER</h1>
    <div id="game-wrapper">
        <div id="ui-layer"><div class="score-board">SCORE: <span id="score">0</span></div></div>
        <div id="feedback" class="feedback"></div>
        <div id="webcam-container"></div>
        <canvas id="game-canvas"></canvas>
    </div>
    <button type="button" id="start-btn" onclick="init()">161 BPM DEMO START</button>

    <audio id="bgm" src="bgm.mp3" preload="auto"></audio>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/c9h0TWwjV/"; 
        let model, webcam, canvas, ctx, gameRunning = false;
        let score = 0, currentPose = "ÎåÄÍ∏∞", notes = [];
        
        // üìä 8Ï£ºÏ∞® ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞
        let stats = { left: 0, right: 0, both: 0, miss: 0, total: 0 };

        // üéµ Îç∞Î™®Í≥° ÏÑ§Ï†ï (161 BPMÏóê ÎßûÏ∂ò 20Í∞ú ÎÖ∏Ìä∏ Íµ¨ÏÑ±)
        const demoSong = [0, 2, 1, 0, 2, 1, 0, 2, 1, 1, 0, 0, 2, 2, 1, 0, 2, 1, 0, 1]; 
        let noteIndex = 0;
        const LANES = [80, 200, 320], HIT_ZONE_Y = 520;

        async function init() {
            document.getElementById("start-btn").style.display = "none";
            model = await tmImage.load(URL + "model.json", URL + "metadata.json");
            webcam = new tmImage.Webcam(200, 200, true);
            await webcam.setup(); await webcam.play();
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            
            canvas = document.getElementById("game-canvas");
            canvas.width = 400; canvas.height = 600;
            ctx = canvas.getContext("2d");
            
            // Ï¥àÍ∏∞Ìôî Î∞è ÏùåÏïÖ Ïû¨ÏÉù
            gameRunning = true; score = 0; noteIndex = 0; notes = [];
            stats = { left: 0, right: 0, both: 0, miss: 0, total: demoSong.length };
            document.getElementById("bgm").currentTime = 0;
            document.getElementById("bgm").play();
            
            spawnNote();
            requestAnimationFrame(gameLoop);
        }

        function spawnNote() {
            if (!gameRunning || noteIndex >= demoSong.length) return;
            const lane = demoSong[noteIndex++];
            const types = ["ÏôºÏÜê", "ÏñëÏÜê", "Ïò§Î•∏ÏÜê"];
            notes.push({ x: LANES[lane], y: -50, type: types[lane], color: lane === 1 ? "#ff00ff" : "#00f3ff" });
            
            // üí° 161 BPM ÏµúÏ†ÅÌôî: 2Î∞ïÏûê Í∞ÑÍ≤©Ïù∏ 745msÎ°ú ÏÑ§Ï†ï
            setTimeout(spawnNote, 745); 
        }

        async function gameLoop() {
            if (!gameRunning) return;
            webcam.update(); await predict();
            draw(); updateNotes();
            
            if (noteIndex >= demoSong.length && notes.length === 0) {
                gameRunning = false;
                document.getElementById("bgm").pause();
                setTimeout(finishGame, 1000);
                return;
            }
            requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0, 0, 400, 600);
            ctx.strokeStyle = "rgba(255, 255, 255, 0.2)"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, HIT_ZONE_Y); ctx.lineTo(400, HIT_ZONE_Y); ctx.stroke();
            
            notes.forEach(note => {
                ctx.fillStyle = note.color;
                ctx.shadowBlur = 15; ctx.shadowColor = note.color;
                ctx.beginPath(); ctx.arc(note.x, note.y, 25, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0;
            });
        }

        function updateNotes() {
            for (let i = notes.length - 1; i >= 0; i--) {
                // üí° 161 BPMÏóê ÎßûÏ∂ò ÏãúÏõêÏãúÏõêÌïú ÎÇôÌïò ÏÜçÎèÑ
                notes[i].y += 8; 
                
                if (notes[i].y > HIT_ZONE_Y - 45 && notes[i].y < HIT_ZONE_Y + 45) {
                    if (currentPose === notes[i].type) {
                        showFeedback("GREAT!");
                        score += 100; document.getElementById("score").innerText = score;
                        if(notes[i].type === "ÏôºÏÜê") stats.left++;
                        else if(notes[i].type === "Ïò§Î•∏ÏÜê") stats.right++;
                        else stats.both++;
                        notes.splice(i, 1); continue;
                    }
                }
                if (notes[i].y > 600) { showFeedback("MISS"); stats.miss++; notes.splice(i, 1); }
            }
        }

        function showFeedback(text) {
            const fb = document.getElementById("feedback");
            fb.innerText = text; fb.style.color = text === "GREAT!" ? "#00f3ff" : "#ff4d4d";
            setTimeout(() => { if(fb.innerText === text) fb.innerText = ""; }, 300);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let highProb = 0;
            for (let i = 0; i < model.getTotalClasses(); i++) {
                if (prediction[i].probability > highProb) {
                    highProb = prediction[i].probability;
                    if (highProb > 0.8) currentPose = prediction[i].className;
                }
            }
        }

        // üìä [8Ï£ºÏ∞®] Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
        function finishGame() {
            const scriptURL = "Î∂ÄÏû•ÎãòÏùò_Íµ¨Í∏Ä_Ïï±Ïä§_Ïä§ÌÅ¨Î¶ΩÌä∏_URL"; 
            const accuracy = ((stats.total - stats.miss) / stats.total * 100).toFixed(1) + "%";
            
            fetch(scriptURL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ score: score, left: stats.left, right: stats.right, both: stats.both, miss: stats.miss, accuracy: accuracy })
            })
            .then(() => {
                alert(`Í≤åÏûÑ ÌÅ¥Î¶¨Ïñ¥!\nÏµúÏ¢Ö Ï†êÏàò: ${score}\nÏ†ïÌôïÎèÑ: ${accuracy}\nÎç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.`);
                document.getElementById("start-btn").style.display = "block";
            });
        }
    </script>
</body>
</html>
